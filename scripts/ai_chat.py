# -*- coding: utf-8 -*-
"""
–ú–æ–¥—É–ª—å –¥–ª—è —á–∞—Ç–∞ —Å –ò–ò –Ω–∞ —Ç–µ–º—É –±–∏–∑–Ω–µ—Å–∞ Ozon.
"""

import os
import sys
import re
import json
import time
import requests
import pandas as pd
from pathlib import Path
from typing import Optional, Tuple, Dict, Any, List
from datetime import datetime, timedelta
from dotenv import load_dotenv
from openpyxl import load_workbook

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
GROQ_API_KEY = os.getenv('GROQ_API_KEY')

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç—á—ë—Ç–∞–º–∏
try:
    script_dir = Path(__file__).resolve().parent
    if str(script_dir) not in sys.path:
        sys.path.insert(0, str(script_dir))
    from recommended_prices import (
        REPORTS_DIR_NAME,
        MONTHS_RU,
        ORDER_SHEET,
    )
except ImportError:
    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, —Å–æ–∑–¥–∞—ë–º –∑–∞–≥–ª—É—à–∫–∏
    REPORTS_DIR_NAME = "reports"
    ORDER_SHEET = "–ó–∞–∫–∞–∑—ã"
    MONTHS_RU = [
        "–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å",
        "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"
    ]
    
    def get_report_path(repo_root: Path, year: int, month: int) -> Path:
        name = f"{MONTHS_RU[month - 1]} {year}.xlsx"
        return repo_root / REPORTS_DIR_NAME / name

GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions"
# –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —á–∞—Ç–∞: groq/compound-mini (70K TPM, –±–µ–∑ –ª–∏–º–∏—Ç–∞ TPD)
# llama-3.3-70b-versatile –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç 12K TPM ‚Äî –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –¥–∞—ë—Ç 429
DEFAULT_MODEL = "groq/compound-mini"
# –ú–æ–¥–µ–ª—å –º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤ .env: GROQ_MODEL=groq/compound-mini
GROQ_MODEL = (os.getenv("GROQ_MODEL") or "").strip() or DEFAULT_MODEL

# –õ–∏–º–∏—Ç—ã –¥–ª—è –º–æ–¥–µ–ª–µ–π Groq API (–Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Å–æ–ª–∏)
# –û–±–Ω–æ–≤–ª—è–π—Ç–µ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –∏–∑–º–µ–Ω—è—Ç—Å—è –≤ –≤–∞—à–µ–º –∞–∫–∫–∞—É–Ω—Ç–µ
MODEL_LIMITS = {
    "llama-3.3-70b-versatile": {
        "rpm": 30,  # Requests per Minute
        "rpd": 1000,  # Requests per Day
        "tpm": 12000,  # Tokens per Minute
        "tpd": 100000,  # Tokens per Day
    },
    "groq/compound": {
        "rpm": 30,
        "rpd": 250,
        "tpm": 70000,
        "tpd": None,  # No limit
    },
    "groq/compound-mini": {
        "rpm": 30,
        "rpd": 250,
        "tpm": 70000,
        "tpd": None,  # No limit
    },
    "llama-3.1-8b-instant": {
        "rpm": 30,
        "rpd": 14400,
        "tpm": 6000,
        "tpd": 500000,
    },
}

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç - —Ç–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –ë–ï–ó –¥–∞–Ω–Ω—ã—Ö
SYSTEM_PROMPT = r"""
–¢—ã ‚Äî AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –±–∏–∑–Ω–µ—Å—É –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ Ozon –∏ —Ä–∞–±–æ—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã OzonReportX.

# 0) –ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å
–î–∞–≤–∞–π –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –∞–Ω–∞–ª–∏–∑ –ø–æ –±–∏–∑–Ω–µ—Å—É Ozon, –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –º–æ–∂–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (TOOLS).

# 0.1) –ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ü–û–í–ï–î–ï–ù–ò–Ø
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞"
–¢—ã –î–û–õ–ñ–ï–ù –≤–µ—Ä–Ω—É—Ç—å –¢–û–õ–¨–ö–û —ç—Ç–æ—Ç JSON (–±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –¥–æ/–ø–æ—Å–ª–µ):
{"type": "DATA_REQUEST", "needs": [{"tool": "list_reports", "args": {}}, {"tool": "get_month_summary", "args": {"period": "2025-12"}}, {"tool": "get_month_summary", "args": {"period": "2025-11"}}, {"tool": "get_month_summary", "args": {"period": "2025-10"}}], "reason": "–ê–Ω–∞–ª–∏–∑ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞"}

–ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–π FINAL_ANSWER —Å —Ç–µ–∫—Å—Ç–æ–º "–Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ" –∏–ª–∏ "–∑–∞–ø—Ä–æ—Å–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ" - —ç—Ç–æ –û–®–ò–ë–ö–ê!

# 1) –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
1) –ù–ï–õ–¨–ó–Ø –≤—ã–¥—É–º—ã–≤–∞—Ç—å —Ü–∏—Ñ—Ä—ã, –ø–µ—Ä–∏–æ–¥—ã, –∑–Ω–∞—á–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—á—ë—Ç–æ–≤ –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤.
   - –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö, –∑–∞–ø—Ä–æ—Å–∏ –∏—Ö —á–µ—Ä–µ–∑ DATA_REQUEST.
2) –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –ø–µ—Ä–∏–æ–¥, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–Ω–æ—Å—è—Ç—Å—è –ª—é–±—ã–µ —Ü–∏—Ñ—Ä—ã –∏ –≤—ã–≤–æ–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: "2025-12" –∏–ª–∏ "–î–µ–∫–∞–±—Ä—å 2025").
3) –ï—Å–ª–∏ –≤ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –ø–æ–ª—è –∏–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ ‚Äî —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏ –≤ FINAL_ANSWER: "–¥–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã" / "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É".
4) –≠–∫–æ–Ω–æ–º—å —Ç–æ–∫–µ–Ω—ã:
   - –ó–∞–ø—Ä–∞—à–∏–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
   - –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π –±–æ–ª—å—à–∏–µ —Å–ø–∏—Å–∫–∏ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
5) –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/—Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∏—Å–ª–∞–ª–∏ –±–ª–æ–∫ "‚úÖ –î–ê–ù–ù–´–ï –£–°–ü–ï–®–ù–û –ü–û–õ–£–ß–ï–ù–´" (–∏–ª–∏ –ª—é–±–æ–π –±–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤),
   —Ç–µ–±–µ –ó–ê–ü–†–ï–©–ï–ù–û –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å DATA_REQUEST. –¢—ã –æ–±—è–∑–∞–Ω –≤–µ—Ä–Ω—É—Ç—å FINAL_ANSWER –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
6) –¢—ã –ù–ï –¥–æ–ª–∂–µ–Ω –æ–±—ä—è—Å–Ω—è—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –∫—É—Ö–Ω—é (–ø—Ä–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —Ç–æ–∫–µ–Ω—ã, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é.

# 1.1) –°–¢–†–û–ñ–ê–ô–®–ï–ï –ü–†–ê–í–ò–õ–û - –ù–ò–ö–û–ì–î–ê –ù–ï –ü–†–û–°–ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ó–ê–ü–†–û–°–ò–¢–¨ –î–ê–ù–ù–´–ï
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π", "—Å—Ä–∞–≤–Ω–∏", "–ø–æ–∫–∞–∂–∏", "–¥–∞–π", "—Å–∫–æ–ª—å–∫–æ" + —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞/–º–µ—Å—è—Ü–∞/–∞—Ä—Ç–∏–∫—É–ª–∞:
   - –¢—ã –î–û–õ–ñ–ï–ù –≤–µ—Ä–Ω—É—Ç—å DATA_REQUEST —Å –Ω—É–∂–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
   - –ó–ê–ü–†–ï–©–ï–ù–û –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å FINAL_ANSWER —Å —Ç–µ–∫—Å—Ç–æ–º —Ç–∏–ø–∞ "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ" –∏–ª–∏ "–Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç—á—ë—Ç–æ–≤"
   - –ó–ê–ü–†–ï–©–ï–ù–û –æ–±—ä—è—Å–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ - —Ç—ã –°–ê–ú –∏—Ö –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—à—å —á–µ—Ä–µ–∑ DATA_REQUEST
   
–ü—Ä–∏–º–µ—Ä—ã –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ø–æ–≤–µ–¥–µ–Ω–∏—è:
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞"
     ‚Üí –¢—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å: {"type": "DATA_REQUEST", "needs": [{"tool": "list_reports", "args": {}}, {"tool": "get_month_summary", "args": {"period": "2025-12"}}, {"tool": "get_month_summary", "args": {"period": "2025-11"}}, {"tool": "get_month_summary", "args": {"period": "2025-10"}}], "reason": "–ê–Ω–∞–ª–∏–∑ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞"}
   
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–°—Ä–∞–≤–Ω–∏ –ø—Ä–∏–±—ã–ª—å –∑–∞ –¥–µ–∫–∞–±—Ä—å –∏ –Ω–æ—è–±—Ä—å"
     ‚Üí –¢—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å: {"type": "DATA_REQUEST", "needs": [{"tool": "get_month_summary", "args": {"period": "2025-12"}}, {"tool": "get_month_summary", "args": {"period": "2025-11"}}], "reason": "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏ –∑–∞ –¥–≤–∞ –º–µ—Å—è—Ü–∞"}

–ü—Ä–∏–º–µ—Ä—ã –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ì–û –ø–æ–≤–µ–¥–µ–Ω–∏—è (–ó–ê–ü–†–ï–©–ï–ù–û):
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞"
     ‚Üí ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: {"type": "FINAL_ANSWER", "answer": "–î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –º–µ—Å—è—á–Ω—ã–µ —Å–≤–æ–¥–∫–∏."}
     ‚Üí ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: {"type": "FINAL_ANSWER", "answer": "–°–µ–π—á–∞—Å –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–∫–∏ –æ—Ç—á—ë—Ç–æ–≤, –±–µ–∑ –º–µ—Ç—Ä–∏–∫. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ get_month_summary."}

# 2) –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞
–¢—ã –û–ë–Ø–ó–ê–ù –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¢–û–õ–¨–ö–û –æ–¥–∏–Ω –≤–∞–ª–∏–¥–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç (–±–µ–∑ Markdown, –±–µ–∑ ``` –∏ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ —Å–Ω–∞—Ä—É–∂–∏ JSON).

–†–∞–∑—Ä–µ—à–µ–Ω–æ —Ç–æ–ª—å–∫–æ 2 —Ç–∏–ø–∞:

A) DATA_REQUEST ‚Äî –µ—Å–ª–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ:
{
  "type": "DATA_REQUEST",
  "needs": [
    {"tool": "<tool_name>", "args": {...}}
  ],
  "reason": "<–∫–æ—Ä–æ—Ç–∫–æ –∑–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ>"
}

B) FINAL_ANSWER ‚Äî –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π:
{
  "type": "FINAL_ANSWER",
  "answer": "<–æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º>"
}

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- –¥–æ–±–∞–≤–ª—è—Ç—å –ª—é–±—ã–µ –ø–æ–ª—è –∫—Ä–æ–º–µ type/needs/reason/answer
- –ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–æ/–ø–æ—Å–ª–µ JSON
- –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –º–∞—Å—Å–∏–≤ –≤–º–µ—Å—Ç–æ –æ–±—ä–µ–∫—Ç–∞

# 3) –ö–∞–∫ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ: DATA_REQUEST –∏–ª–∏ FINAL_ANSWER
üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢—ã –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ - —Ç—ã –°–ê–ú –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—à—å –∏—Ö —á–µ—Ä–µ–∑ DATA_REQUEST.

–í–æ–∑–≤—Ä–∞—â–∞–π FINAL_ANSWER –¢–û–õ–¨–ö–û –µ—Å–ª–∏:
- –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π (—á—Ç–æ —É–º–µ–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞, –∫–∞–∫ —Å—á–∏—Ç–∞—Ç—å –º–∞—Ä–∂—É, –∫–∞–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ —Ç.–ø.)
- –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —á–∏—Å–µ–ª –ò –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Ç—á—ë—Ç–æ–≤
- –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª –ø–µ—Ä–∏–æ–¥/–∞—Ä—Ç–∏–∫—É–ª –∏ –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–µ –≤ —Å–∞–º–æ–º FINAL_ANSWER (–±–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)

üö® –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–æ–∑–≤—Ä–∞—â–∞–π DATA_REQUEST, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç:
- "–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π", "—Å—Ä–∞–≤–Ω–∏", "–ø–æ–∫–∞–∂–∏", "–¥–∞–π", "—Å–∫–æ–ª—å–∫–æ", "–∫–∞–∫–∞—è" + —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞/–º–µ—Å—è—Ü–∞/–∞—Ä—Ç–∏–∫—É–ª–∞
- –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã (–≤—ã—Ä—É—á–∫–∞/–ø—Ä–∏–±—ã–ª—å/–º–∞—Ä–∂–∞/–∑–∞–∫–∞–∑—ã/–∫–æ–º–∏—Å—Å–∏–∏) –∑–∞ –ø–µ—Ä–∏–æ–¥
- –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–∞ / —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–æ–≤
- —Ç–æ–ø—ã –ø–æ –ø—Ä–∏–±—ã–ª–∏/–∑–∞–∫–∞–∑–∞–º
- —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å/–º–∏–Ω–∏–º–∞–ª—å–Ω—É—é/–∂–µ–ª–∞—Ç–µ–ª—å–Ω—É—é —Ü–µ–Ω—É –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º
- ABC&XYZ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Å–ø–∏—Å–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Å–≤–æ–¥–∫–∏
- –õ–Æ–ë–û–ô –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Ç—á—ë—Ç–æ–≤ –∏–ª–∏ costs.xlsx

üö® –ó–ê–ü–†–ï–©–ï–ù–û (—ç—Ç–æ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê):
- –ü—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –º–µ—Å—è—á–Ω—ã–µ —Å–≤–æ–¥–∫–∏")
- –û–±—ä—è—Å–Ω—è—Ç—å, —á—Ç–æ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ, –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã –∏—Ö –∑–∞–ø—Ä–æ—Å–∏—Ç—å
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å FINAL_ANSWER —Å –ø—Ä–æ—Å—å–±–æ–π –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- –í–æ–∑–≤—Ä–∞—â–∞—Ç—å FINAL_ANSWER —Å —Ç–µ–∫—Å—Ç–æ–º —Ç–∏–ø–∞ "–Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç—á—ë—Ç–æ–≤" –∏–ª–∏ "–¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–∫–∏ –æ—Ç—á—ë—Ç–æ–≤"

üö® –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–µ—Å—è—Ü–µ–≤", "–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π N –º–µ—Å—è—Ü–µ–≤", "—Å—Ä–∞–≤–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–µ—Å—è—Ü–µ–≤":
- –°–ù–ê–ß–ê–õ–ê –∑–∞–ø—Ä–æ—Å–∏ list_reports {}, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
- –ó–ê–¢–ï–ú –≤ –û–î–ù–û–ú DATA_REQUEST –∑–∞–ø—Ä–æ—Å–∏ get_month_summary –¥–ª—è –ö–ê–ñ–î–û–ì–û –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö N –º–µ—Å—è—Ü–µ–≤
- –ù–ï –¥–µ–ª–∞–π –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ - –∑–∞–ø—Ä–æ—Å–∏ –≤—Å–µ —Å—Ä–∞–∑—É –≤ –æ–¥–Ω–æ–º DATA_REQUEST
- –ü—Ä–∏–º–µ—Ä –¥–ª—è "–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞": {"type": "DATA_REQUEST", "needs": [{"tool": "list_reports", "args": {}}, {"tool": "get_month_summary", "args": {"period": "2025-12"}}, {"tool": "get_month_summary", "args": {"period": "2025-11"}}, {"tool": "get_month_summary", "args": {"period": "2025-10"}}], "reason": "–ê–Ω–∞–ª–∏–∑ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞"}

–ï—Å–ª–∏ –ø–µ—Ä–∏–æ–¥/–∞—Ä—Ç–∏–∫—É–ª –Ω–µ —É–∫–∞–∑–∞–Ω –∏ –±–µ–∑ –Ω–µ–≥–æ –Ω–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ:
- –ù–ï –≤—ã–∑—ã–≤–∞–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- –≤–µ—Ä–Ω–∏ FINAL_ANSWER —Å –ø—Ä–æ—Å—å–±–æ–π —É—Ç–æ—á–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥/–∞—Ä—Ç–∏–∫—É–ª (–∫–æ—Ä–æ—Ç–∫–æ, 1‚Äì2 –≤–æ–ø—Ä–æ—Å–∞)

# 4) –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã OzonReportX (–∫—Ä–∞—Ç–∫–æ)
–ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å:
- costs.xlsx: —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ —Ä–∞—Å—á—ë—Ç–Ω—ã–µ —Ü–µ–Ω—ã (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è/–∂–µ–ª–∞—Ç–µ–ª—å–Ω–∞—è), –∏ –¥—Ä. –ø–æ–ª—è
- –º–µ—Å—è—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã –ø—Ä–æ–¥–∞–∂ Excel (–ª–∏—Å—Ç "–ó–∞–∫–∞–∑—ã"): —Å–≤–æ–¥–∫–∞ –º–µ—Ç—Ä–∏–∫ + –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–æ–≤
- ABC&XYZ –æ—Ç—á—ë—Ç—ã: –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å (A/B/C) –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–ø—Ä–æ—Å–∞ (X/Y/Z)

–§–æ—Ä–º—É–ª—ã:
- –ü—Ä–∏–±—ã–ª—å –ø–æ –∑–∞–∫–∞–∑—É = "–°—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è" - "–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å"
- –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å = (–ø—Ä–∏–±—ã–ª—å / –≤—ã—Ä—É—á–∫–∞) * 100%
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ = –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å / (1 - (–ö–æ–º–∏—Å—Å–∏—è% + –õ–æ–≥–∏—Å—Ç–∏–∫–∞%) - –º–∞—Ä–∂–∞)

# 5) –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (TOOLS)
–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ DATA_REQUEST.

–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:
- list_reports {}
- list_abcxyz_reports {}

–ú–µ—Å—è—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã:
- get_month_summary {"period": "2025-12"}
- get_top_profit {"period": "2025-12", "n": 10}
- get_top_orders {"period": "2025-12", "n": 10}
- get_artikul_stats {"period": "2025-12", "artikul": "12345"}
- search_artikul {"query": "–¥–æ—Å–∫–∞ –∫—Ä—É–≥–ª–∞—è"}

Costs:
- get_costs_columns {}
- get_artikul_cost {"artikul": "12345"}
- get_costs_bulk {"artikuls": ["12345","67890"]}

ABC&XYZ:
- get_abcxyz_summary {"period": "–ù–æ—è–±—Ä—å 2025-–î–µ–∫–∞–±—Ä—å 2025"}
- get_artikul_abcxyz {"period": "...", "artikul": "12345"}
- get_category_list {"period": "...", "category": "AX"}

# 6) –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–∏–æ–¥–∞
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –º–µ—Å—è—Ü —Å–ª–æ–≤–∞–º–∏ ("–î–µ–∫–∞–±—Ä—å 2025"), –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –∫–∞–∫ period.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "2025-12" ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç.

# 7) –°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞ –≤ FINAL_ANSWER
- –ö–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –° —ç–º–æ–¥–∑–∏ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤ (üìä üìà üí∞ ‚ö†Ô∏è ‚úÖ ‚ùå üîç üí°)
- –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö ‚Äî –æ–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ (—á—Ç–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞ Ozon / –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ)

"""


def load_costs_data(repo_root: Path) -> Optional[Dict[str, Any]]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ costs.xlsx.
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ costs.xlsx –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    costs_path = repo_root / "costs.xlsx"
    if not costs_path.exists():
        return None
    
    try:
        df = pd.read_excel(costs_path)
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º DataFrame –≤ —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —É–¥–æ–±–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –ò–ò
        costs_data = {
            "–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤": len(df),
            "–ö–æ–ª–æ–Ω–∫–∏": list(df.columns),
            "–î–∞–Ω–Ω—ã–µ": []
        }
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –≤ —Å–ª–æ–≤–∞—Ä—å
        for _, row in df.iterrows():
            row_dict = {}
            for col in df.columns:
                value = row[col]
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º NaN –≤ None
                if pd.isna(value):
                    value = None
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —á–∏—Å–ª–∞ –≤ float –¥–ª—è JSON-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                elif isinstance(value, (int, float)):
                    value = float(value)
                else:
                    value = str(value)
                row_dict[col] = value
            costs_data["–î–∞–Ω–Ω—ã–µ"].append(row_dict)
        
        return costs_data
        
    except Exception as e:
        return None


def load_monthly_report_detailed_data(report_path: Path) -> Optional[Dict[str, Any]]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ (–ª–∏—Å—Ç "–ó–∞–∫–∞–∑—ã").
    –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤.
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    if not report_path.exists():
        return None
    
    try:
        df = pd.read_excel(report_path, sheet_name=ORDER_SHEET)
        
        if df.empty:
            return None
        
        report_name = report_path.stem
        detailed_data = {
            "–ü–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞": report_name,
            "–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤": len(df),
            "–ö–æ–ª–æ–Ω–∫–∏": list(df.columns),
        }
        
        # –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º
        if "–ê—Ä—Ç–∏–∫—É–ª" in df.columns:
            artikul_stats = []
            
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º
            for artikul in df["–ê—Ä—Ç–∏–∫—É–ª"].dropna().unique():
                artikul_df = df[df["–ê—Ä—Ç–∏–∫—É–ª"] == artikul]
                
                stats = {
                    "–ê—Ä—Ç–∏–∫—É–ª": str(artikul),
                    "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤": len(artikul_df),
                }
                
                # –°—É–º–º–∏—Ä—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏
                numeric_cols = ["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç.", "–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏", "–ö–æ–º–∏—Å—Å–∏—è –∑–∞ –ø—Ä–æ–¥–∞–∂—É Ozon", 
                               "–õ–æ–≥–∏—Å—Ç–∏–∫–∞ (–í–∫–ª—é—á–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–¥–∞–≤—Ü–∞)", 
                               "–°—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è", "–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å", "–ü—Ä–∏–±—ã–ª—å"]
                
                for col in numeric_cols:
                    if col in artikul_df.columns:
                        total = artikul_df[col].sum()
                        if pd.notna(total):
                            stats[f"–°—É–º–º–∞ {col}"] = float(total)
                            stats[f"–°—Ä–µ–¥–Ω—è—è {col}"] = float(artikul_df[col].mean())
                
                # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
                if "–°—Ç–∞—Ç—É—Å" in artikul_df.columns:
                    status_counts = artikul_df["–°—Ç–∞—Ç—É—Å"].value_counts().to_dict()
                    stats["–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º"] = {str(k): int(v) for k, v in status_counts.items()}
                
                # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ö–µ–º–∞–º
                if "–°—Ö–µ–º–∞" in artikul_df.columns:
                    schema_counts = artikul_df["–°—Ö–µ–º–∞"].value_counts().to_dict()
                    stats["–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ö–µ–º–∞–º"] = {str(k): int(v) for k, v in schema_counts.items()}
                
                artikul_stats.append(stats)
            
            detailed_data["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º"] = artikul_stats
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        if "–°—Ç–∞—Ç—É—Å" in df.columns:
            status_counts = df["–°—Ç–∞—Ç—É—Å"].value_counts().to_dict()
            detailed_data["–û–±—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º"] = {str(k): int(v) for k, v in status_counts.items()}
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å—Ö–µ–º–∞–º
        if "–°—Ö–µ–º–∞" in df.columns:
            schema_counts = df["–°—Ö–µ–º–∞"].value_counts().to_dict()
            detailed_data["–û–±—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ö–µ–º–∞–º"] = {str(k): int(v) for k, v in schema_counts.items()}
        
        # –¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏
        if "–ü—Ä–∏–±—ã–ª—å" in df.columns and "–ê—Ä—Ç–∏–∫—É–ª" in df.columns:
            top_profit = df.groupby("–ê—Ä—Ç–∏–∫—É–ª")["–ü—Ä–∏–±—ã–ª—å"].sum().nlargest(10)
            detailed_data["–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏"] = {
                str(artikul): float(profit) for artikul, profit in top_profit.items()
            }
        
        # –¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤
        if "–ê—Ä—Ç–∏–∫—É–ª" in df.columns:
            top_orders = df["–ê—Ä—Ç–∏–∫—É–ª"].value_counts().head(10)
            detailed_data["–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤"] = {
                str(artikul): int(count) for artikul, count in top_orders.items()
            }
        
        return detailed_data
        
    except Exception as e:
        return None


def load_report_summary(report_path: Path) -> Optional[Dict[str, Any]]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤–æ–¥–∫—É –∏–∑ –º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞.
    –ß–∏—Ç–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏–∑ –∫–æ–ª–æ–Ω–æ–∫ P –∏ Q –ª–∏—Å—Ç–∞ "–ó–∞–∫–∞–∑—ã".
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –æ—Ç—á—ë—Ç–∞ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    if not report_path.exists():
        return None
    
    try:
        wb = load_workbook(report_path, data_only=True)
        if ORDER_SHEET not in wb.sheetnames:
            return None
        
        ws = wb[ORDER_SHEET]
        
        # –ß–∏—Ç–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏–∑ –∫–æ–ª–æ–Ω–æ–∫ P –∏ Q
        # –°—Ç—Ä—É–∫—Ç—É—Ä–∞: P1-Q1: –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞, P2-Q2: –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å, –∏ —Ç.–¥.
        summary = {}
        
        # –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç—Ä–æ–∫ –∫ –Ω–∞–∑–≤–∞–Ω–∏—è–º –º–µ—Ç—Ä–∏–∫
        metrics_map = {
            1: "–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞",
            2: "–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å",
            3: "–ò—Ç–æ–≥–æ–≤–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å",
            4: "–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ (Net Profit Margin) %",
            5: "COGS (–≤–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å)",
            6: "Gross Profit Margin –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ –≤–∞–ª–æ–≤–æ–π –ø—Ä–∏–±—ã–ª–∏ %",
            7: "–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã",
            8: "–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ Ozon",
            9: "–í–Ω–µ—à–Ω–∏–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥",
            10: "–°—Ä–µ–¥–Ω–∏–π —á–µ–∫",
            11: "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤",
            12: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
            13: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
            14: "–ö–æ–º–∏—Å—Å–∏–∏ Ozon %",
            15: "–õ–æ–≥–∏—Å—Ç–∏–∫–∞ %",
        }
        
        for row_num, metric_name in metrics_map.items():
            value = ws[f"Q{row_num}"].value
            if value is not None:
                try:
                    # –ü—Ä–æ–±—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —á–∏—Å–ª–æ
                    if isinstance(value, (int, float)):
                        summary[metric_name] = float(value)
                    elif isinstance(value, str):
                        # –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä–æ–∫—É
                        cleaned = value.replace(",", ".").replace(" ", "")
                        summary[metric_name] = float(cleaned)
                    else:
                        summary[metric_name] = value
                except (ValueError, TypeError):
                    summary[metric_name] = value
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–∏–æ–¥–µ –æ—Ç—á—ë—Ç–∞ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        report_name = report_path.stem  # –ë–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        summary["–ü–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞"] = report_name
        
        return summary if summary else None
        
    except Exception as e:
        return None


def list_available_reports(repo_root: Path) -> List[Path]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤.
    
    Returns:
        –°–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º –æ—Ç—á—ë—Ç–æ–≤, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
    """
    reports_dir = repo_root / REPORTS_DIR_NAME
    if not reports_dir.exists():
        return []
    
    reports = []
    for file_path in reports_dir.glob("*.xlsx"):
        if file_path.is_file():
            reports.append(file_path)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
    reports.sort(key=lambda p: p.stat().st_mtime, reverse=True)
    
    return reports


def list_abc_xyz_reports(repo_root: Path) -> List[Path]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö ABC&XYZ –æ—Ç—á—ë—Ç–æ–≤.
    
    Returns:
        –°–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º ABC&XYZ –æ—Ç—á—ë—Ç–æ–≤, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
    """
    abc_xyz_dir = repo_root / "ABC&XYZ reports"
    if not abc_xyz_dir.exists():
        return []
    
    reports = []
    for file_path in abc_xyz_dir.glob("*.xlsx"):
        if file_path.is_file():
            reports.append(file_path)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
    reports.sort(key=lambda p: p.stat().st_mtime, reverse=True)
    
    return reports


def load_abc_xyz_summary(report_path: Path) -> Optional[Dict[str, Any]]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤–æ–¥–∫—É –∏–∑ ABC&XYZ –æ—Ç—á—ë—Ç–∞.
    –ß–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–∏—Å—Ç–æ–≤ ABC, XYZ –∏ –ò—Ç–æ–≥.
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –æ—Ç—á—ë—Ç–∞ –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    if not report_path.exists():
        return None
    
    try:
        wb = load_workbook(report_path, data_only=True)
        summary = {}
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–∏–æ–¥–µ –æ—Ç—á—ë—Ç–∞ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        report_name = report_path.stem  # –ë–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
        summary["–ü–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞"] = report_name
        summary["–¢–∏–ø –æ—Ç—á—ë—Ç–∞"] = "ABC&XYZ"
        
        # –ß–∏—Ç–∞–µ–º –ª–∏—Å—Ç "–ò—Ç–æ–≥" –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        if "–ò—Ç–æ–≥" in wb.sheetnames:
            ws = wb["–ò—Ç–æ–≥"]
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –≤ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ABCXYZ
            abcxyz_counts = {}
            total_articles = 0
            
            # –ò—â–µ–º –∫–æ–ª–æ–Ω–∫—É —Å –æ–±—â–µ–π –æ—Ü–µ–Ω–∫–æ–π ABCXYZ (–æ–±—ã—á–Ω–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –∏–ª–∏ –ø—Ä–µ–¥–ø–æ—Å–ª–µ–¥–Ω—è—è)
            # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
            header_row = 1
            abcxyz_col = None
            
            for col_idx in range(1, ws.max_column + 1):
                cell_value = ws.cell(header_row, col_idx).value
                if cell_value and ("ABCXYZ" in str(cell_value) or "–û—Ü–µ–Ω–∫–∞" in str(cell_value)):
                    abcxyz_col = col_idx
                    break
            
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É, –ø—Ä–æ–±—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–ª–æ–Ω–∫—É
            if abcxyz_col is None:
                abcxyz_col = ws.max_column
            
            # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            for row in range(2, ws.max_row + 1):
                cell_value = ws.cell(row, abcxyz_col).value
                if cell_value:
                    category = str(cell_value).strip()
                    if category and category != "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö":
                        abcxyz_counts[category] = abcxyz_counts.get(category, 0) + 1
                        total_articles += 1
            
            summary["–í—Å–µ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–æ–≤"] = total_articles
            summary["–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ABCXYZ"] = abcxyz_counts
        
        # –ß–∏—Ç–∞–µ–º –ª–∏—Å—Ç "ABC" –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –ø—Ä–∏–±—ã–ª–∏
        if "ABC" in wb.sheetnames:
            try:
                df_abc = pd.read_excel(report_path, sheet_name="ABC")
                if not df_abc.empty:
                    # –ò—â–µ–º –∫–æ–ª–æ–Ω–∫—É —Å –ø—Ä–∏–±—ã–ª—å—é
                    profit_col = None
                    for col in df_abc.columns:
                        if "–ø—Ä–∏–±—ã–ª—å" in str(col).lower() or "profit" in str(col).lower():
                            profit_col = col
                            break
                    
                    if profit_col is not None:
                        total_profit = df_abc[profit_col].sum()
                        summary["–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å (ABC)"] = float(total_profit)
                        
                        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∞—Ä—Ç–∏–∫—É–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º A, B, C
                        if "ABC" in df_abc.columns:
                            abc_dist = df_abc["ABC"].value_counts().to_dict()
                            summary["–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ABC"] = {str(k): int(v) for k, v in abc_dist.items()}
            except Exception:
                pass
        
        # –ß–∏—Ç–∞–µ–º –ª–∏—Å—Ç "XYZ" –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        if "XYZ" in wb.sheetnames:
            try:
                df_xyz = pd.read_excel(report_path, sheet_name="XYZ")
                if not df_xyz.empty:
                    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∞—Ä—Ç–∏–∫—É–ª—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º X, Y1, Y2, Y3, Y, Z
                    if "XYZ" in df_xyz.columns:
                        xyz_dist = df_xyz["XYZ"].value_counts().to_dict()
                        summary["–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ XYZ"] = {str(k): int(v) for k, v in xyz_dist.items()}
            except Exception:
                pass
        
        return summary if summary else None
        
    except Exception as e:
        return None


def format_costs_data_for_ai(costs_data: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ costs.xlsx –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ò–ò.
    
    Args:
        costs_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ costs.xlsx
    
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
    """
    if not costs_data:
        return ""
    
    lines = ["\n" + "="*60]
    lines.append("## –î–ê–ù–ù–´–ï –ò–ó –§–ê–ô–õ–ê –°–ï–ë–ï–°–¢–û–ò–ú–û–°–¢–ò (costs.xlsx)")
    lines.append("="*60)
    lines.append(f"\n–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: {costs_data.get('–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤', 0)}")
    lines.append(f"–ö–æ–ª–æ–Ω–∫–∏: {', '.join(costs_data.get('–ö–æ–ª–æ–Ω–∫–∏', []))}\n")
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 20 —Ç–æ–≤–∞—Ä–æ–≤ (—á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤)
    # –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É
    data_items = costs_data.get("–î–∞–Ω–Ω—ã–µ", [])
    show_count = min(20, len(data_items))
    
    if show_count > 0:
        lines.append(f"### –î–∞–Ω–Ω—ã–µ –ø–æ —Ç–æ–≤–∞—Ä–∞–º (–ø–æ–∫–∞–∑–∞–Ω–æ {show_count} –∏–∑ {len(data_items)}):\n")
        
        for idx, item in enumerate(data_items[:show_count], 1):
            lines.append(f"**–¢–æ–≤–∞—Ä {idx}:**")
            for key, value in item.items():
                if value is not None:
                    if isinstance(value, float):
                        if value >= 1000:
                            lines.append(f"  - {key}: {value:,.0f}")
                        else:
                            lines.append(f"  - {key}: {value:.2f}")
                    else:
                        lines.append(f"  - {key}: {value}")
            lines.append("")
        
        if len(data_items) > show_count:
            lines.append(f"\n*... –∏ –µ—â—ë {len(data_items) - show_count} —Ç–æ–≤–∞—Ä–æ–≤ (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞—Ä—Ç–∏–∫—É–ª)*\n")
    
    return "\n".join(lines)


def format_detailed_report_data_for_ai(detailed_data: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ò–ò.
    
    Args:
        detailed_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç—á—ë—Ç–∞
    
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
    """
    if not detailed_data:
        return ""
    
    lines = [f"\n### –î–ï–¢–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï: {detailed_data.get('–ü–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥')}\n"]
    
    if "–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤" in detailed_data:
        lines.append(f"- –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: {detailed_data['–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤']}")
    
    if "–û–±—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º" in detailed_data:
        lines.append("\n**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:**")
        for status, count in detailed_data["–û–±—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º"].items():
            lines.append(f"  - {status}: {count}")
    
    if "–û–±—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ö–µ–º–∞–º" in detailed_data:
        lines.append("\n**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —Å—Ö–µ–º–∞–º:**")
        for schema, count in detailed_data["–û–±—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ö–µ–º–∞–º"].items():
            lines.append(f"  - {schema}: {count}")
    
    if "–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏" in detailed_data:
        lines.append("\n**–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏:**")
        for artikul, profit in detailed_data["–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏"].items():
            lines.append(f"  - {artikul}: {profit:,.0f} —Ä—É–±.")
    
    if "–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤" in detailed_data:
        lines.append("\n**–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤:**")
        for artikul, count in detailed_data["–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤"].items():
            lines.append(f"  - {artikul}: {count} –∑–∞–∫–∞–∑–æ–≤")
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤)
    if "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º" in detailed_data:
        artikul_stats = detailed_data["–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º"]
        show_count = min(10, len(artikul_stats))
        
        lines.append(f"\n**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º (–ø–æ–∫–∞–∑–∞–Ω–æ {show_count} –∏–∑ {len(artikul_stats)}):**")
        for stats in artikul_stats[:show_count]:
            lines.append(f"\n- **–ê—Ä—Ç–∏–∫—É–ª {stats.get('–ê—Ä—Ç–∏–∫—É–ª', 'N/A')}:**")
            lines.append(f"  - –ó–∞–∫–∞–∑–æ–≤: {stats.get('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤', 0)}")
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (—Å—É–º–º—ã, –∞ –Ω–µ —Å—Ä–µ–¥–Ω–∏–µ, —á—Ç–æ–±—ã —ç–∫–æ–Ω–æ–º–∏—Ç—å —Ç–æ–∫–µ–Ω—ã)
            key_metrics = ["–°—É–º–º–∞ –ü—Ä–∏–±—ã–ª—å", "–°—É–º–º–∞ –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏", "–°—É–º–º–∞ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç.", 
                          "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º", "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ö–µ–º–∞–º"]
            for key in key_metrics:
                if key in stats:
                    value = stats[key]
                    if isinstance(value, dict):
                        lines.append(f"  - {key}: {value}")
                    elif isinstance(value, float):
                        if value >= 1000:
                            lines.append(f"  - {key}: {value:,.0f}")
                        else:
                            lines.append(f"  - {key}: {value:.2f}")
                    else:
                        lines.append(f"  - {key}: {value}")
        
        if len(artikul_stats) > show_count:
            lines.append(f"\n*... –∏ –µ—â—ë {len(artikul_stats) - show_count} –∞—Ä—Ç–∏–∫—É–ª–æ–≤ (–≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∞—Ä—Ç–∏–∫—É–ª –∏–ª–∏ –ø–µ—Ä–∏–æ–¥)*")
    
    return "\n".join(lines)


def format_all_reports_summary_for_ai(
    monthly_summaries: List[Dict[str, Any]], 
    abc_xyz_summaries: List[Dict[str, Any]],
    costs_data: Optional[Dict[str, Any]] = None,
    monthly_detailed_data: List[Dict[str, Any]] = None
) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–≤–æ–¥–∫–∏ –≤—Å–µ—Ö –æ—Ç—á—ë—Ç–æ–≤ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ò–ò.
    
    Args:
        monthly_summaries: –°–ø–∏—Å–æ–∫ —Å–≤–æ–¥–æ–∫ –º–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤
        abc_xyz_summaries: –°–ø–∏—Å–æ–∫ —Å–≤–æ–¥–æ–∫ ABC&XYZ –æ—Ç—á—ë—Ç–æ–≤
        costs_data: –î–∞–Ω–Ω—ã–µ –∏–∑ costs.xlsx
        monthly_detailed_data: –°–ø–∏—Å–æ–∫ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –º–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤
    
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ –≤—Å–µ–º–∏ —Å–≤–æ–¥–∫–∞–º–∏
    """
    lines = []
    
    # –î–∞–Ω–Ω—ã–µ –∏–∑ costs.xlsx
    if costs_data:
        lines.append(format_costs_data_for_ai(costs_data))
        lines.append("")
    
    # –ú–µ—Å—è—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã - —Å–≤–æ–¥–∫–∏
    if monthly_summaries:
        lines.append("\n" + "="*60)
        lines.append("## –ú–ï–°–Ø–ß–ù–´–ï –û–¢–ß–Å–¢–´ –ü–û –ü–†–û–î–ê–ñ–ê–ú (–°–í–û–î–ö–ò)")
        lines.append("="*60)
        
        for summary in monthly_summaries:
            lines.append(format_report_summary_for_ai(summary))
            lines.append("")  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –æ—Ç—á—ë—Ç–∞–º–∏
    
    # –ú–µ—Å—è—á–Ω—ã–µ –æ—Ç—á—ë—Ç—ã - –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if monthly_detailed_data:
        lines.append("\n" + "="*60)
        lines.append("## –ú–ï–°–Ø–ß–ù–´–ï –û–¢–ß–Å–¢–´ –ü–û –ü–†–û–î–ê–ñ–ê–ú (–î–ï–¢–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï)")
        lines.append("="*60)
        
        for detailed in monthly_detailed_data:
            lines.append(format_detailed_report_data_for_ai(detailed))
            lines.append("")  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –æ—Ç—á—ë—Ç–∞–º–∏
    
    # ABC&XYZ –æ—Ç—á—ë—Ç—ã
    if abc_xyz_summaries:
        lines.append("\n" + "="*60)
        lines.append("## ABC&XYZ –û–¢–ß–Å–¢–´ (–ê–ù–ê–õ–ò–ó –ü–†–ò–ë–´–õ–¨–ù–û–°–¢–ò –ò –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–ò)")
        lines.append("="*60)
        
        for summary in abc_xyz_summaries:
            lines.append(format_abc_xyz_summary_for_ai(summary))
            lines.append("")  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –æ—Ç—á—ë—Ç–∞–º–∏
    
    return "\n".join(lines)


def format_abc_xyz_summary_for_ai(summary: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–≤–æ–¥–∫—É ABC&XYZ –æ—Ç—á—ë—Ç–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ò–ò.
    
    Args:
        summary: –°–ª–æ–≤–∞—Ä—å —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ ABC&XYZ –æ—Ç—á—ë—Ç–∞
    
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ —Å–≤–æ–¥–∫–æ–π
    """
    if not summary:
        return ""
    
    lines = [f"\n### ABC&XYZ –û–¢–ß–Å–¢: {summary.get('–ü–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥')}\n"]
    
    if "–í—Å–µ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–æ–≤" in summary:
        lines.append(f"- –í—Å–µ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–æ–≤: {summary['–í—Å–µ–≥–æ –∞—Ä—Ç–∏–∫—É–ª–æ–≤']}")
    
    if "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ABC" in summary:
        lines.append("\n**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏ (ABC):**")
        for category, count in summary["–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ABC"].items():
            lines.append(f"  - –ö–∞—Ç–µ–≥–æ—Ä–∏—è {category}: {count} –∞—Ä—Ç–∏–∫—É–ª–æ–≤")
    
    if "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ XYZ" in summary:
        lines.append("\n**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Å–ø—Ä–æ—Å–∞ (XYZ):**")
        for category, count in summary["–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ XYZ"].items():
            lines.append(f"  - –ö–∞—Ç–µ–≥–æ—Ä–∏—è {category}: {count} –∞—Ä—Ç–∏–∫—É–ª–æ–≤")
    
    if "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ABCXYZ" in summary:
        lines.append("\n**–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (ABCXYZ):**")
        for category, count in sorted(summary["–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ABCXYZ"].items()):
            lines.append(f"  - {category}: {count} –∞—Ä—Ç–∏–∫—É–ª–æ–≤")
    
    if "–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å (ABC)" in summary:
        profit = summary["–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å (ABC)"]
        if profit >= 1000:
            lines.append(f"\n- –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ –ø–µ—Ä–∏–æ–¥: {profit:,.0f} —Ä—É–±.")
        else:
            lines.append(f"\n- –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ –ø–µ—Ä–∏–æ–¥: {profit:.2f} —Ä—É–±.")
    
    return "\n".join(lines)


def format_report_summary_for_ai(summary: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–≤–æ–¥–∫—É –æ—Ç—á—ë—Ç–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ò–ò.
    
    Args:
        summary: –°–ª–æ–≤–∞—Ä—å —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –æ—Ç—á—ë—Ç–∞
    
    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ —Å–≤–æ–¥–∫–æ–π
    """
    if not summary:
        return ""
    
    lines = [f"\n## –î–ê–ù–ù–´–ï –ò–ó –ú–ï–°–Ø–ß–ù–û–ì–û –û–¢–ß–Å–¢–ê: {summary.get('–ü–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥')}\n"]
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –º–µ—Ç—Ä–∏–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    financial_metrics = [
        "–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞",
        "–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å",
        "–ò—Ç–æ–≥–æ–≤–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å",
        "COGS (–≤–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å)",
        "–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã",
    ]
    
    margin_metrics = [
        "–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ (Net Profit Margin) %",
        "Gross Profit Margin –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ –≤–∞–ª–æ–≤–æ–π –ø—Ä–∏–±—ã–ª–∏ %",
    ]
    
    order_metrics = [
        "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤",
        "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
        "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤",
        "–°—Ä–µ–¥–Ω–∏–π —á–µ–∫",
    ]
    
    cost_metrics = [
        "–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ Ozon",
        "–í–Ω–µ—à–Ω–∏–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥",
        "–ö–æ–º–∏—Å—Å–∏–∏ Ozon %",
        "–õ–æ–≥–∏—Å—Ç–∏–∫–∞ %",
    ]
    
    def format_value(key: str, value: Any) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞."""
        if isinstance(value, (int, float)):
            if "–ø—Ä–æ—Ü–µ–Ω—Ç" in key.lower() or "%" in key:
                return f"{value:.2f}%"
            elif value >= 1000:
                return f"{value:,.0f} —Ä—É–±."
            else:
                return f"{value:.2f} —Ä—É–±."
        return str(value)
    
    if any(k in summary for k in financial_metrics):
        lines.append("### –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:")
        for metric in financial_metrics:
            if metric in summary:
                lines.append(f"- {metric}: {format_value(metric, summary[metric])}")
    
    if any(k in summary for k in margin_metrics):
        lines.append("\n### –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å:")
        for metric in margin_metrics:
            if metric in summary:
                lines.append(f"- {metric}: {format_value(metric, summary[metric])}")
    
    if any(k in summary for k in order_metrics):
        lines.append("\n### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤:")
        for metric in order_metrics:
            if metric in summary:
                lines.append(f"- {metric}: {format_value(metric, summary[metric])}")
    
    if any(k in summary for k in cost_metrics):
        lines.append("\n### –†–∞—Å—Ö–æ–¥—ã –∏ –∫–æ–º–∏—Å—Å–∏–∏:")
        for metric in cost_metrics:
            if metric in summary:
                lines.append(f"- {metric}: {format_value(metric, summary[metric])}")
    
    return "\n".join(lines)


# ============================================================================
# –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ (TOOLS) - —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –ø–æ –∑–∞–ø—Ä–æ—Å—É
# ============================================================================

class Tools:
    """–ö–ª–∞—Å—Å —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º."""
    
    def __init__(self, repo_root: Path):
        self.repo_root = repo_root
        self._costs_df = None  # –ö–µ—à –¥–ª—è costs.xlsx
        self._costs_columns = None
    
    def _get_costs_df(self) -> Optional[pd.DataFrame]:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç costs.xlsx —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º."""
        if self._costs_df is None:
            costs_path = self.repo_root / "costs.xlsx"
            if costs_path.exists():
                try:
                    self._costs_df = pd.read_excel(costs_path)
                except Exception:
                    return None
        return self._costs_df
    
    def _normalize_period(self, period: str) -> Optional[Path]:
        """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø–µ—Ä–∏–æ–¥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –æ—Ç—á—ë—Ç–∞."""
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: "2025-12", "–î–µ–∫–∞–±—Ä—å 2025", "12 2025"
        reports = list_available_reports(self.repo_root)
        
        # –§–æ—Ä–º–∞—Ç "2025-12"
        if re.match(r'^\d{4}-\d{2}$', period):
            year, month = period.split('-')
            month_num = int(month)
            if 1 <= month_num <= 12:
                name = f"{MONTHS_RU[month_num - 1]} {year}.xlsx"
                for r in reports:
                    if r.name == name:
                        return r
        
        # –§–æ—Ä–º–∞—Ç "–î–µ–∫–∞–±—Ä—å 2025" –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        period_lower = period.lower()
        for r in reports:
            if period_lower in r.stem.lower() or r.stem.lower() in period_lower:
                return r
        
        return None
    
    def list_reports(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Å—è—á–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤."""
        reports = list_available_reports(self.repo_root)
        return {
            "reports": [
                {"period": r.stem, "file": r.name, "path": str(r)}
                for r in reports
            ],
            "count": len(reports)
        }
    
    def list_abcxyz_reports(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö ABC&XYZ –æ—Ç—á—ë—Ç–æ–≤."""
        reports = list_abc_xyz_reports(self.repo_root)
        return {
            "reports": [
                {"period": r.stem, "file": r.name, "path": str(r)}
                for r in reports
            ],
            "count": len(reports)
        }
    
    def get_month_summary(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–∫—É –∑–∞ –º–µ—Å—è—Ü."""
        period = args.get("period", "")
        if not period:
            return {"error": "–ü–∞—Ä–∞–º–µ—Ç—Ä period –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}
        
        report_path = self._normalize_period(period)
        if not report_path:
            return {"error": f"–û—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ '{period}' –Ω–µ –Ω–∞–π–¥–µ–Ω"}
        
        summary = load_report_summary(report_path)
        if summary:
            return summary
        return {"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–¥–∫—É"}
    
    def get_top_profit(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-N –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏."""
        period = args.get("period", "")
        n = args.get("n", 10)
        
        if not period:
            return {"error": "–ü–∞—Ä–∞–º–µ—Ç—Ä period –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}
        
        report_path = self._normalize_period(period)
        if not report_path:
            return {"error": f"–û—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ '{period}' –Ω–µ –Ω–∞–π–¥–µ–Ω"}
        
        detailed = load_monthly_report_detailed_data(report_path)
        if not detailed:
            return {"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}
        
        top_profit = detailed.get("–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏", {})
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ n
        sorted_items = sorted(top_profit.items(), key=lambda x: x[1], reverse=True)[:n]
        return {"top_profit": dict(sorted_items), "period": period}
    
    def get_top_orders(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-N –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤."""
        period = args.get("period", "")
        n = args.get("n", 10)
        
        if not period:
            return {"error": "–ü–∞—Ä–∞–º–µ—Ç—Ä period –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}
        
        report_path = self._normalize_period(period)
        if not report_path:
            return {"error": f"–û—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ '{period}' –Ω–µ –Ω–∞–π–¥–µ–Ω"}
        
        detailed = load_monthly_report_detailed_data(report_path)
        if not detailed:
            return {"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}
        
        top_orders = detailed.get("–¢–æ–ø-10 –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤", {})
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ n
        sorted_items = sorted(top_orders.items(), key=lambda x: x[1], reverse=True)[:n]
        return {"top_orders": dict(sorted_items), "period": period}
    
    def get_artikul_stats(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∑–∞ –ø–µ—Ä–∏–æ–¥."""
        period = args.get("period", "")
        artikul = args.get("artikul", "")
        
        if not period or not artikul:
            return {"error": "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã period –∏ artikul –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã"}
        
        report_path = self._normalize_period(period)
        if not report_path:
            return {"error": f"–û—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ '{period}' –Ω–µ –Ω–∞–π–¥–µ–Ω"}
        
        detailed = load_monthly_report_detailed_data(report_path)
        if not detailed:
            return {"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"}
        
        artikul_stats = detailed.get("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º", [])
        for stats in artikul_stats:
            if str(stats.get("–ê—Ä—Ç–∏–∫—É–ª", "")) == str(artikul):
                return {"artikul": artikul, "period": period, "stats": stats}
        
        return {"error": f"–ê—Ä—Ç–∏–∫—É–ª '{artikul}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç—á—ë—Ç–µ –∑–∞ '{period}'"}
    
    def search_artikul(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–ü–æ–∏—Å–∫ –∞—Ä—Ç–∏–∫—É–ª–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É."""
        query = args.get("query", "").lower()
        if not query:
            return {"error": "–ü–∞—Ä–∞–º–µ—Ç—Ä query –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}
        
        df = self._get_costs_df()
        if df is None:
            return {"error": "–§–∞–π–ª costs.xlsx –Ω–µ –Ω–∞–π–¥–µ–Ω"}
        
        # –ò—â–µ–º –≤ –∫–æ–ª–æ–Ω–∫–µ –∞—Ä—Ç–∏–∫—É–ª–∞
        results = []
        for col in df.columns:
            if "–∞—Ä—Ç–∏–∫—É–ª" in col.lower() or "artikul" in col.lower() or "offer_id" in col.lower():
                matches = df[df[col].astype(str).str.lower().str.contains(query, na=False)]
                for _, row in matches.iterrows():
                    results.append({col: str(row[col]) for col in df.columns})
                break
        
        return {"results": results[:20], "count": len(results)}  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 20 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    
    def get_costs_columns(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ –≤ costs.xlsx."""
        df = self._get_costs_df()
        if df is None:
            return {"error": "–§–∞–π–ª costs.xlsx –Ω–µ –Ω–∞–π–¥–µ–Ω"}
        return {"columns": list(df.columns), "count": len(df.columns)}
    
    def get_artikul_cost(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É –∏–∑ costs.xlsx."""
        artikul = args.get("artikul", "")
        if not artikul:
            return {"error": "–ü–∞—Ä–∞–º–µ—Ç—Ä artikul –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}
        
        df = self._get_costs_df()
        if df is None:
            return {"error": "–§–∞–π–ª costs.xlsx –Ω–µ –Ω–∞–π–¥–µ–Ω"}
        
        # –ò—â–µ–º –∞—Ä—Ç–∏–∫—É–ª
        for col in df.columns:
            if "–∞—Ä—Ç–∏–∫—É–ª" in col.lower() or "artikul" in col.lower() or "offer_id" in col.lower():
                matches = df[df[col].astype(str) == str(artikul)]
                if not matches.empty:
                    row = matches.iloc[0]
                    return {col: str(row[col]) if pd.notna(row[col]) else None for col in df.columns}
                break
        
        return {"error": f"–ê—Ä—Ç–∏–∫—É–ª '{artikul}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ costs.xlsx"}
    
    def get_costs_bulk(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∞—Ä—Ç–∏–∫—É–ª–∞–º."""
        artikuls = args.get("artikuls", [])
        if not artikuls:
            return {"error": "–ü–∞—Ä–∞–º–µ—Ç—Ä artikuls –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}
        
        df = self._get_costs_df()
        if df is None:
            return {"error": "–§–∞–π–ª costs.xlsx –Ω–µ –Ω–∞–π–¥–µ–Ω"}
        
        results = []
        for col in df.columns:
            if "–∞—Ä—Ç–∏–∫—É–ª" in col.lower() or "artikul" in col.lower() or "offer_id" in col.lower():
                matches = df[df[col].astype(str).isin([str(a) for a in artikuls])]
                for _, row in matches.iterrows():
                    results.append({col: str(row[col]) if pd.notna(row[col]) else None for col in df.columns})
                break
        
        return {"results": results, "count": len(results)}
    
    def get_abcxyz_summary(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–∫—É ABC&XYZ –æ—Ç—á—ë—Ç–∞."""
        period = args.get("period", "")
        if not period:
            return {"error": "–ü–∞—Ä–∞–º–µ—Ç—Ä period –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"}
        
        reports = list_abc_xyz_reports(self.repo_root)
        report_path = None
        for r in reports:
            if period in r.stem:
                report_path = r
                break
        
        if not report_path:
            return {"error": f"ABC&XYZ –æ—Ç—á—ë—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ '{period}' –Ω–µ –Ω–∞–π–¥–µ–Ω"}
        
        summary = load_abc_xyz_summary(report_path)
        if summary:
            return summary
        return {"error": "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–¥–∫—É"}
    
    def get_artikul_abcxyz(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∞—Ä—Ç–∏–∫—É–ª–∞ –≤ ABC&XYZ."""
        # –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
        return {"error": "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ"}
    
    def get_category_list(self, args: Dict[str, Any]) -> Dict[str, Any]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞—Ä—Ç–∏–∫—É–ª–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."""
        # –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
        return {"error": "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ"}


def parse_ai_response(response_text: str) -> Optional[Dict[str, Any]]:
    """
    –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç –ò–ò –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç DATA_REQUEST –∏–ª–∏ FINAL_ANSWER.
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å type –∏ –¥–∞–Ω–Ω—ã–º–∏, –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
    """
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
    response_text = response_text.strip()
    
    # –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∫–∞–∫ JSON (–µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å—Ç—ã–π JSON)
    try:
        parsed = json.loads(response_text)
        if isinstance(parsed, dict) and "type" in parsed:
            return parsed
    except json.JSONDecodeError:
        pass
    
    # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ JSON –≤ code blocks (```json ... ```)
    json_match = re.search(r'```json\s*(\{.*?\})\s*```', response_text, re.DOTALL)
    if json_match:
        try:
            parsed = json.loads(json_match.group(1))
            if isinstance(parsed, dict) and "type" in parsed:
                return parsed
        except json.JSONDecodeError:
            pass
    
    # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ JSON –æ–±—ä–µ–∫—Ç —Å –±–∞–ª–∞–Ω—Å–æ–º —Å–∫–æ–±–æ–∫
    # –ò—â–µ–º –Ω–∞—á–∞–ª–æ JSON –æ–±—ä–µ–∫—Ç–∞
    start_idx = response_text.find('{')
    if start_idx != -1:
        # –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Å–∏–º–≤–æ–ª
        brace_count = 0
        in_string = False
        escape_next = False
        
        for i in range(start_idx, len(response_text)):
            char = response_text[i]
            
            if escape_next:
                escape_next = False
                continue
            
            if char == '\\':
                escape_next = True
                continue
            
            if char == '"' and not escape_next:
                in_string = not in_string
                continue
            
            if not in_string:
                if char == '{':
                    brace_count += 1
                elif char == '}':
                    brace_count -= 1
                    if brace_count == 0:
                        # –ù–∞—à–ª–∏ –ø–æ–ª–Ω—ã–π JSON –æ–±—ä–µ–∫—Ç
                        json_str = response_text[start_idx:i+1]
                        try:
                            parsed = json.loads(json_str)
                            if isinstance(parsed, dict) and "type" in parsed:
                                return parsed
                        except json.JSONDecodeError:
                            pass
                        break
    
    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ JSON - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None (–Ω–µ –¥–µ–ª–∞–µ–º fallback –Ω–∞ FINAL_ANSWER)
    return None


def execute_tools(tools: Tools, needs: List[Dict[str, Any]]) -> Dict[str, Any]:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º.
    
    Args:
        tools: –≠–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—Å–∞ Tools
        needs: –°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ [{"tool": "...", "args": {...}}]
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
        –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫.
    """
    results = {}
    
    for idx, need in enumerate(needs):
        tool_name = need.get("tool", "")
        args = need.get("args", {})
        
        if not hasattr(tools, tool_name):
            key = f"{tool_name}_{idx}" if tool_name in results else tool_name
            results[key] = {"error": f"–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç '{tool_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω"}
            continue
        
        try:
            tool_func = getattr(tools, tool_name)
            result = tool_func(args)
            
            # –ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É–∂–µ –≤—ã–∑—ã–≤–∞–ª—Å—è - —Å–æ–∑–¥–∞—ë–º —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            if tool_name in results:
                # –ï—Å–ª–∏ —É–∂–µ —Å–ø–∏—Å–æ–∫ - –¥–æ–±–∞–≤–ª—è–µ–º, –∏–Ω–∞—á–µ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ø–∏—Å–æ–∫
                if isinstance(results[tool_name], list):
                    results[tool_name].append(result)
                else:
                    results[tool_name] = [results[tool_name], result]
            else:
                results[tool_name] = result
        except Exception as e:
            key = f"{tool_name}_{idx}" if tool_name in results else tool_name
            results[key] = {"error": str(e)}
    
    return results


def format_tool_results(results: Dict[str, Any]) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ò–ò."""
    lines = [
        "=" * 70,
        "‚úÖ –î–ê–ù–ù–´–ï –£–°–ü–ï–®–ù–û –ü–û–õ–£–ß–ï–ù–´ –ò–ó –ü–†–û–ì–†–ê–ú–ú–´",
        "=" * 70,
        "",
        "–¢—ã –∑–∞–ø—Ä–æ—Å–∏–ª –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∏—Ö –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∞.",
        "–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –¥–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.",
        "",
        "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:",
        "- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û FINAL_ANSWER (–Ω–µ DATA_REQUEST)",
        "- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ",
        "- –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
        "",
        "=" * 70,
        "–†–ï–ó–£–õ–¨–¢–ê–¢–´ –í–´–ü–û–õ–ù–ï–ù–ò–Ø –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í:",
        "=" * 70,
        ""
    ]
    
    for tool_name, result in results.items():
        lines.append(f"üìä –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {tool_name}")
        
        # –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - —Å–ø–∏—Å–æ–∫ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –æ–¥–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞)
        if isinstance(result, list):
            for idx, item in enumerate(result):
                if idx > 0:
                    lines.append("")  # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
                if isinstance(item, dict) and "error" in item:
                    lines.append(f"   ‚ùå –û—à–∏–±–∫–∞ (–≤—ã–∑–æ–≤ {idx + 1}): {item['error']}")
                else:
                    result_str = json.dumps(item, ensure_ascii=False, indent=2)
                    lines.append(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç {idx + 1}:")
                    lines.append(f"   {result_str}")
        elif isinstance(result, dict) and "error" in result:
            lines.append(f"   ‚ùå –û—à–∏–±–∫–∞: {result['error']}")
        else:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
            result_str = json.dumps(result, ensure_ascii=False, indent=2)
            lines.append(f"   {result_str}")
        lines.append("")
    
    lines.append("=" * 70)
    lines.append("–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –í–µ—Ä–Ω–∏ JSON: {\"type\": \"FINAL_ANSWER\", \"answer\": \"...\"}")
    lines.append("=" * 70)
    
    return "\n".join(lines)


def chat_with_ai(user_message: str, conversation_history: list = None, data_block: Optional[str] = None, context_state: Optional[str] = None, temperature: float = 0.7, max_tokens: int = 2000) -> Tuple[Optional[str], Optional[Dict[str, Any]], Optional[Dict[str, Any]]]:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç —Å –ò–ò –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç.
    
    Args:
        user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        conversation_history: –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (—Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3-6 —Å–æ–æ–±—â–µ–Ω–∏–π)
        data_block: –ë–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ò–ò (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
        context_state: –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (selected_period, selected_artikul –∏ —Ç.–¥.)
        temperature: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (0.2 –¥–ª—è —Ä–µ–∂–∏–º–∞ B, 0.7 –¥–ª—è —Ä–µ–∂–∏–º–∞ A)
        max_tokens: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ (400-700 –¥–ª—è —Ä–µ–∂–∏–º–∞ A, 2000 –¥–ª—è —Ä–µ–∂–∏–º–∞ B)
    
    Returns:
        –ö–æ—Ä—Ç–µ–∂ (–æ—Ç–≤–µ—Ç –ò–ò, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏–º–∏—Ç–∞—Ö) –∏–ª–∏ (None, None, None) –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    """
    if not GROQ_API_KEY:
        print("‚ö†Ô∏è GROQ_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env —Ñ–∞–π–ª–µ.")
        print("   –î–æ–±–∞–≤—å—Ç–µ GROQ_API_KEY=–≤–∞—à_–∫–ª—é—á –≤ —Ñ–∞–π–ª .env")
        return None, None, None
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è API
    system_prompt = SYSTEM_PROMPT
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
    if context_state:
        system_prompt += f"\n\n## –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï:\n{context_state}\n"
    
    messages = [{"role": "system", "content": system_prompt}]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3-6 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤)
    if conversation_history:
        # –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 —Å–æ–æ–±—â–µ–Ω–∏–π (3 –ø–∞—Ä—ã –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)
        recent_history = conversation_history[-6:] if len(conversation_history) > 6 else conversation_history
        messages.extend(recent_history)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –µ—Å—Ç—å
    if data_block:
        # –ö–æ–≥–¥–∞ –ø–µ—Ä–µ–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ, —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –Ω—É–∂–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        messages.append({
            "role": "user", 
            "content": f"""‚ö†Ô∏è –í–ê–ñ–ù–û: –¢—ã –ø–æ–ª—É—á–∏–ª –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –¢–µ–ø–µ—Ä—å —Ç—ã –î–û–õ–ñ–ï–ù –¥–∞—Ç—å FINAL_ANSWER.

–î–ê–ù–ù–´–ï:
{data_block}

–í–û–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {user_message}

–ò–ù–°–¢–†–£–ö–¶–ò–Ø: 
- –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON —Å type="FINAL_ANSWER" –∏ –ø–æ–ª–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–π DATA_REQUEST - –¥–∞–Ω–Ω—ã–µ —É–∂–µ –ø–æ–ª—É—á–µ–Ω—ã
- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –≤ FINAL_ANSWER"""
        })
    else:
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        messages.append({"role": "user", "content": user_message})
    
    max_retries = 2  # –ø—Ä–∏ 429 –ø–æ–≤—Ç–æ—Ä—è–µ–º –¥–æ 2 —Ä–∞–∑ (–≤—Å–µ–≥–æ 3 –ø–æ–ø—ã—Ç–∫–∏)
    last_error = None
    
    try:
        for attempt in range(max_retries + 1):
            try:
                response = requests.post(
                    GROQ_API_URL,
                    headers={
                        "Authorization": f"Bearer {GROQ_API_KEY}",
                        "Content-Type": "application/json"
                    },
                    json={
                        "model": GROQ_MODEL,
                        "messages": messages,
                        "temperature": temperature,
                        "max_tokens": max_tokens
                    },
                    timeout=60
                )
                
                response.raise_for_status()
                data = response.json()
                
                ai_response = data.get("choices", [{}])[0].get("message", {}).get("content", "")
                usage_info = data.get("usage", {})
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–º–∏—Ç–∞—Ö –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –æ—Ç–≤–µ—Ç–∞
                rate_limit_info = {}
                headers = response.headers
                
                rate_limit_info["limit"] = (
                    headers.get("x-ratelimit-limit-tokens") or 
                    headers.get("x-ratelimit-limit") or
                    headers.get("ratelimit-limit-tokens") or
                    headers.get("x-ratelimit-limit-tpm") or
                    headers.get("x-ratelimit-limit-tpd") or
                    None
                )
                rate_limit_info["remaining"] = (
                    headers.get("x-ratelimit-remaining-tokens") or 
                    headers.get("x-ratelimit-remaining") or
                    headers.get("ratelimit-remaining-tokens") or
                    headers.get("x-ratelimit-remaining-tpm") or
                    headers.get("x-ratelimit-remaining-tpd") or
                    None
                )
                rate_limit_info["reset"] = (
                    headers.get("x-ratelimit-reset-tokens") or 
                    headers.get("x-ratelimit-reset") or
                    headers.get("ratelimit-reset-tokens") or
                    headers.get("x-ratelimit-reset-tpm") or
                    headers.get("x-ratelimit-reset-tpd") or
                    None
                )
                
                if rate_limit_info["limit"] is None:
                    rate_limit_info["limit"] = headers.get("x-ratelimit-limit-requests") or headers.get("x-ratelimit-limit-rpm")
                    rate_limit_info["remaining"] = headers.get("x-ratelimit-remaining-requests") or headers.get("x-ratelimit-remaining-rpm")
                    rate_limit_info["reset"] = headers.get("x-ratelimit-reset-requests") or headers.get("x-ratelimit-reset-rpm")
                
                rate_limit_info["model"] = GROQ_MODEL
                
                if ai_response:
                    return ai_response, usage_info, rate_limit_info
                else:
                    print("‚ö†Ô∏è –ò–ò –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç.")
                    return None, None, None
                    
            except requests.exceptions.RequestException as e:
                last_error = e
                if hasattr(e, 'response') and e.response is not None and e.response.status_code == 429:
                    try:
                        error_data = e.response.json()
                        error_msg = error_data.get('error', {}).get('message', '')
                        wait_time_match = re.search(r'(\d+\.?\d*)\s*s', error_msg)
                        wait_sec = float(wait_time_match.group(1)) + 2.0 if wait_time_match else 10.0
                        wait_sec = min(wait_sec, 60.0)
                        if attempt < max_retries:
                            print(f"\n   ‚ö† 429, –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_sec:.0f} —Å‚Ä¶", end="\r")
                            time.sleep(wait_sec)
                            continue
                    except Exception:
                        pass
                # –ù–µ 429 –∏–ª–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å –ø–æ–ø—ã—Ç–∫–∏ ‚Äî –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É –∏ –≤—ã—Ö–æ–¥–∏–º
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Groq API: {e}")
                if hasattr(e, 'response') and e.response is not None:
                    try:
                        error_data = e.response.json()
                        error_msg = error_data.get('error', {}).get('message', '')
                        if e.response.status_code == 429:
                            print(f"\n   ‚ö† –õ–∏–º–∏—Ç TPM. –í .env –∑–∞–¥–∞–π—Ç–µ GROQ_MODEL=groq/compound-mini –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É.")
                        else:
                            print(f"   –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {error_data}")
                    except Exception:
                        print(f"   –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {getattr(e.response, 'text', '')[:200]}")
                return None, None, None
        
        return None, None, None
    
    except Exception as e:
        print(f"‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        return None, None, None


def start_chat_session():
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é —á–∞—Ç–∞ —Å –ò–ò.
    """
    print("\n¬∑ OzonReportX AI ‚Äî —á–∞—Ç —Å –ò–ò. –í–æ–ø—Ä–æ—Å—ã –ø–æ –±–∏–∑–Ω–µ—Å—É Ozon. –í—ã—Ö–æ–¥: –≤—ã—Ö–æ–¥ / exit / quit\n")
    
    if not GROQ_API_KEY:
        print("‚ö†Ô∏è GROQ_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ .env —Ñ–∞–π–ª–µ.")
        print("   –î–æ–±–∞–≤—å—Ç–µ GROQ_API_KEY=–≤–∞—à_–∫–ª—é—á –≤ —Ñ–∞–π–ª .env")
        return
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–µ–Ω—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    script_dir = Path(__file__).resolve().parent
    repo_root = script_dir.parent
    
    # –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    tools = Tools(repo_root)
    
    # –ü–∞–º—è—Ç—å —Å–µ—Å—Å–∏–∏ (server-side, –±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤)
    session_memory = {
        "selected_period": None,
        "selected_artikul": None,
        "default_margin_settings": None,
        "last_comparison_periods": []
    }
    
    print(f"‚úÖ –ì–æ—Ç–æ–≤. –ú–æ–¥–µ–ª—å: {GROQ_MODEL}\n")
    
    conversation_history = []
    
    while True:
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_input = input("–í—ã: ").strip()
            
            if not user_input:
                continue
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤—ã—Ö–æ–¥–∞
            if user_input.lower() in ('–≤—ã—Ö–æ–¥', 'exit', 'quit', 'q'):
                print("\nüëã –í—ã—Ö–æ–¥ –≤ –º–µ–Ω—é.\n")
                break
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
            context_state_lines = []
            if session_memory["selected_period"]:
                context_state_lines.append(f"selected_period={session_memory['selected_period']}")
            if session_memory["selected_artikul"]:
                context_state_lines.append(f"selected_artikul={session_memory['selected_artikul']}")
            context_state = "\n".join(context_state_lines) if context_state_lines else None
            
            # –†–ï–ñ–ò–ú A: –ü–ª–∞–Ω/–£—Ç–æ—á–Ω–µ–Ω–∏–µ
            print("   ‚Ä¶", end="\r")
            ai_response, usage_info, rate_limit_info = chat_with_ai(
                user_input, 
                conversation_history, 
                data_block=None,
                context_state=context_state,
                temperature=0.7,
                max_tokens=600  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è —Ä–µ–∂–∏–º–∞ A
            )
            
            print(" " * 50, end="\r")
            
            if not ai_response:
                print("\n‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.\n")
                continue
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º rate_limit_info, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if rate_limit_info is None:
                rate_limit_info = {}
            
            # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –ò–ò
            parsed_response = parse_ai_response(ai_response)
            
            # –ï—Å–ª–∏ –ø–∞—Ä—Å–µ—Ä –≤–µ—Ä–Ω—É–ª None - –¥–µ–ª–∞–µ–º –æ–¥–∏–Ω —Ä–µ—Ç—Ä–∞–π —Å –ø—Ä–æ—Å—å–±–æ–π –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å
            if parsed_response is None:
                print("   üîÑ –ü–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É—é –æ—Ç–≤–µ—Ç...", end="\r")
                retry_messages = [
                    {"role": "system", "content": SYSTEM_PROMPT},
                    {"role": "user", "content": f"""–¢–≤–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç –Ω–µ –±—ã–ª –≤–∞–ª–∏–¥–Ω—ã–º JSON. –ü–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π –µ–≥–æ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.

–¢–≤–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç:
{ai_response}

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON –æ–±—ä–µ–∫—Ç (–±–µ–∑ Markdown, –±–µ–∑ ```) –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
- {{"type": "DATA_REQUEST", "needs": [...], "reason": "..."}} –∏–ª–∏
- {{"type": "FINAL_ANSWER", "answer": "..."}}"""}
                ]
                
                try:
                    retry_response = requests.post(
                        GROQ_API_URL,
                        headers={
                            "Authorization": f"Bearer {GROQ_API_KEY}",
                            "Content-Type": "application/json"
                        },
                        json={
                            "model": GROQ_MODEL,
                            "messages": retry_messages,
                            "temperature": 0.2,  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
                            "max_tokens": 500
                        },
                        timeout=30
                    )
                    retry_response.raise_for_status()
                    retry_data = retry_response.json()
                    retry_ai_response = retry_data.get("choices", [{}])[0].get("message", {}).get("content", "")
                    parsed_response = parse_ai_response(retry_ai_response)
                    if parsed_response:
                        ai_response = retry_ai_response
                except Exception:
                    pass
                
                print(" " * 50, end="\r")
                
                # –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ä–µ—Ç—Ä–∞—è –≤—Å—ë –µ—â—ë None - fallback –Ω–∞ FINAL_ANSWER
                if parsed_response is None:
                    parsed_response = {"type": "FINAL_ANSWER", "answer": "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å."}
            
            if parsed_response and parsed_response.get("type") == "DATA_REQUEST":
                # –ò–ò –∑–∞–ø—Ä–æ—Å–∏–ª –¥–∞–Ω–Ω—ã–µ - –≤—ã–ø–æ–ª–Ω—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (—Å–∫—Ä—ã—Ç–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
                needs = parsed_response.get("needs", [])
                reason = parsed_response.get("reason", "")
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                print("   ‚Ä¶", end="\r")
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
                tool_results = execute_tools(tools, needs)
                data_block = format_tool_results(tool_results)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–º—è—Ç—å —Å–µ—Å—Å–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–æ–≤
                # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä–∏–æ–¥–æ–≤ - —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π
                periods_found = []
                for need in needs:
                    args = need.get("args", {})
                    if "period" in args:
                        periods_found.append(args["period"])
                    if "artikul" in args:
                        session_memory["selected_artikul"] = args["artikul"]
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–∏–æ–¥ (–∏–ª–∏ –ø–µ—Ä–≤—ã–π, –µ—Å–ª–∏ –æ–¥–∏–Ω)
                if periods_found:
                    session_memory["selected_period"] = periods_found[-1]
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–∏–æ–¥–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                    if len(periods_found) > 1:
                        session_memory["last_comparison_periods"] = periods_found
                
                # –†–ï–ñ–ò–ú B: –û—Ç–≤–µ—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ (temperature=0.2 –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º–∞—Ç–∞)
                print("ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ...", end="\r")
                
                ai_response_final, usage_info2, rate_limit_info2 = chat_with_ai(
                    user_input,
                    conversation_history,
                    data_block=data_block,
                    context_state=context_state,
                    temperature=0.2,  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ B
                    max_tokens=2000
                )
                
                print(" " * 50, end="\r")
                
                if ai_response_final:
                    parsed_final = parse_ai_response(ai_response_final)
                    
                    # –ï—Å–ª–∏ –ò–ò —Å–Ω–æ–≤–∞ –≤–µ—Ä–Ω—É–ª DATA_REQUEST –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ (–º–∞–∫—Å 2 —É—Ä–æ–≤–Ω—è)
                    max_iterations = 2
                    iteration = 0
                    current_response = ai_response_final
                    current_parsed = parsed_final
                    
                    while current_parsed and current_parsed.get("type") == "DATA_REQUEST" and iteration < max_iterations:
                        iteration += 1
                        print("   ‚Ä¶", end="\r")
                        
                        # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
                        additional_needs = current_parsed.get("needs", [])
                        additional_results = execute_tools(tools, additional_needs)
                        additional_data = format_tool_results(additional_results)
                        
                        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                        combined_data = f"{data_block}\n\n–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï:\n{additional_data}"
                        
                        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç —Å –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                        current_response, _, rate_limit_info2 = chat_with_ai(
                            user_input,
                            conversation_history,
                            data_block=combined_data,
                            context_state=context_state,
                            temperature=0.2,  # –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ B
                            max_tokens=2000
                        )
                        
                        if current_response:
                            current_parsed = parse_ai_response(current_response)
                        else:
                            break
                    
                    print(" " * 50, end="\r")
                    
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                    if current_parsed and current_parsed.get("type") == "FINAL_ANSWER":
                        final_answer = current_parsed.get("answer", current_response)
                    elif current_parsed and current_parsed.get("type") == "DATA_REQUEST":
                        # –ï—Å–ª–∏ –ò–ò –≤—Å—ë –µ—â—ë –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç
                        final_answer = current_response
                        # –£–±–∏—Ä–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
                        if "{" in final_answer and '"type"' in final_answer:
                            json_start = final_answer.find('{')
                            if json_start > 0:
                                final_answer = final_answer[:json_start].strip()
                            else:
                                json_end = final_answer.rfind('}')
                                if json_end < len(final_answer) - 1:
                                    final_answer = final_answer[json_end+1:].strip()
                        
                        if not final_answer or len(final_answer) < 10:
                            final_answer = "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏."
                    else:
                        final_answer = current_response
                    
                    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    print(f"\nü§ñ –ò–ò: {final_answer}\n")
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (—Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –Ω–µ DATA_REQUEST)
                    conversation_history.append({"role": "user", "content": user_input})
                    conversation_history.append({"role": "assistant", "content": final_answer})
                    
                    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ª–∏–º–∏—Ç–∞—Ö –∏–∑ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                    if rate_limit_info2:
                        rate_limit_info = rate_limit_info2
                else:
                    print("\n‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò.\n")
                    continue
                    
            else:
                # –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö
                if parsed_response and parsed_response.get("type") == "FINAL_ANSWER":
                    final_answer = parsed_response.get("answer", ai_response)
                else:
                    # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å
                    final_answer = ai_response
                    # –£–±–∏—Ä–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º —Å–ª—É—á–∞–π–Ω–æ –æ–∫–∞–∑–∞–ª—Å—è
                    if "{" in final_answer and '"type"' in final_answer and '"DATA_REQUEST"' in final_answer:
                        # –≠—Ç–æ –æ—à–∏–±–∫–∞ - –ò–ò –≤–µ—Ä–Ω—É–ª DATA_REQUEST –≤–º–µ—Å—Ç–æ FINAL_ANSWER
                        # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç–æ–≤—É—é —á–∞—Å—Ç—å
                        json_start = final_answer.find('{')
                        if json_start > 0:
                            final_answer = final_answer[:json_start].strip()
                        if not final_answer:
                            final_answer = "–î–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å –º–Ω–µ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Ç–æ—á–Ω–∏—Ç–µ, –∫–∞–∫–∏–µ –∏–º–µ–Ω–Ω–æ –¥–∞–Ω–Ω—ã–µ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç."
                
                print(f"\nü§ñ –ò–ò: {final_answer}\n")
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                conversation_history.append({"role": "user", "content": user_input})
                conversation_history.append({"role": "assistant", "content": final_answer})
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 6 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (3 –ø–∞—Ä—ã –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç)
            if len(conversation_history) > 6:
                conversation_history = conversation_history[-6:]
            
            # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–æ–¥–µ–ª–∏ –∏ –ª–∏–º–∏—Ç–∞—Ö –∏–∑ Groq API
            model = rate_limit_info.get("model", GROQ_MODEL) if rate_limit_info else GROQ_MODEL
            limit = rate_limit_info.get("limit") if rate_limit_info else None
            remaining = rate_limit_info.get("remaining") if rate_limit_info else None
            
            info_lines = [f"ü§ñ –ú–æ–¥–µ–ª—å: {model}"]
            
            if limit is not None and remaining is not None:
                try:
                    limit_val = int(limit)
                    remaining_val = int(remaining)
                    info_lines.append(f"üìä –õ–∏–º–∏—Ç: {remaining_val:,}/{limit_val:,}")
                except (ValueError, TypeError):
                    pass
            
            print(" | ".join(info_lines) + "\n")
                
        except KeyboardInterrupt:
            print("\nüëã –í—ã—Ö–æ–¥ –≤ –º–µ–Ω—é.\n")
            break
        except EOFError:
            print("\nüëã –í—ã—Ö–æ–¥ –≤ –º–µ–Ω—é.\n")
            break
        except Exception as e:
            print(f"\n‚ö† –û—à–∏–±–∫–∞: {e}\n")


def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–æ–¥—É–ª—è –∫–∞–∫ —Å–∫—Ä–∏–ø—Ç–∞."""
    start_chat_session()


if __name__ == "__main__":
    main()
